# 功能代码映射表 - Gemini CLI 中文汉化版

> 📋 详细记录所有自定义功能的代码位置，便于升级时快速定位和保护重要修改

## 🎯 核心自定义功能映射

### 1. 🇨🇳 国际化系统

#### 📁 完全新增的文件
```
packages/cli/src/i18n/
├── index.ts                 # 主要导出和初始化
├── types.ts                 # 国际化类型定义
└── locales/
    └── zh-CN.ts            # 中文语言包（2000+行翻译）
```

**功能说明**：
- `index.ts`: 导出 `t()` 函数和语言切换功能
- `types.ts`: 定义 `TranslationKey` 类型
- `zh-CN.ts`: 包含所有界面文字的中文翻译

**升级注意**：⚠️ 这些文件是完全自定义的，升级时必须完整保留

---

### 2. 🔧 增强命令系统

#### 📂 新增命令文件详细映射

##### `/baseurl` 命令 - API端点设置
```typescript
文件: packages/cli/src/ui/commands/baseurlCommand.ts
功能: 设置 GEMINI_API_BASE_URL 环境变量
依赖: 
  - fs/promises (文件操作)
  - path (路径处理)
  - os (用户目录)
关键函数:
  - action(): 主要命令逻辑
  - updateEnvFile(): 更新环境文件
  - removeFromEnvFile(): 移除环境变量
```

##### `/api` 命令 - 内部API端点
```typescript
文件: packages/cli/src/ui/commands/apiCommand.ts
功能: 设置 CODE_ASSIST_ENDPOINT 环境变量
关键函数:
  - action(): 主要命令逻辑
  - setApiEndpointInEnvFile(): 设置API端点
  - removeApiEndpointFromEnvFile(): 移除API端点
```

##### `/setkey` 命令 - API密钥管理
```typescript
文件: packages/cli/src/ui/commands/setkeyCommand.ts
功能: 设置 GEMINI_API_KEY，增强版本
修改内容: 添加中文提示和更好的错误处理
关键函数:
  - action(): 主要命令逻辑
  - saveApiKeyToEnvFile(): 保存API密钥
```

##### `/status` 命令 - 系统状态查看
```typescript
文件: packages/cli/src/ui/commands/statusCommand.ts
功能: 显示所有配置状态的中文版本
显示内容:
  - API密钥状态
  - API端点配置
  - 模型设置
  - 环境变量
  - 系统信息
```

##### 其他增强命令
```typescript
/debug   -> packages/cli/src/ui/commands/debugCommand.ts
/yolo    -> packages/cli/src/ui/commands/yoloCommand.ts  
/sandbox -> packages/cli/src/ui/commands/sandboxCommand.ts
/model   -> packages/cli/src/ui/commands/modelCommand.ts
/globalprompt   -> packages/cli/src/ui/commands/globalPromptCommand.ts
/projectprompt  -> packages/cli/src/ui/commands/projectPromptCommand.ts
```

#### 📝 命令注册中心
```typescript
文件: packages/cli/src/services/BuiltinCommandLoader.ts
修改内容: 在 allDefinitions 数组中添加所有新增命令
重要性: ⚠️ 升级时必须保留所有自定义命令的导入和注册
```

---

### 3. 🎨 界面中文化映射

#### 📱 核心UI组件修改

##### 帮助系统
```typescript
文件: packages/cli/src/ui/components/Help.tsx
修改内容: 
  - 将所有帮助文本替换为中文
  - 添加中文命令说明
  - 保持原有功能逻辑
关键修改: 第50-200行的帮助文本内容
```

##### 输入提示组件
```typescript
文件: packages/cli/src/ui/components/Composer.tsx
修改内容:
  - 输入框占位符中文化
  - 错误提示中文化
  - 状态信息中文化
关键修改: 第120-150行的提示文本
```

##### 对话框管理
```typescript
文件: packages/cli/src/ui/components/DialogManager.tsx
修改内容:
  - 对话框标题中文化
  - 按钮文本中文化
  - 确认信息中文化
```

##### 设置界面
```typescript
文件: packages/cli/src/ui/components/SettingsDialog.tsx
修改内容:
  - 设置项名称中文化
  - 描述信息中文化
  - 验证消息中文化
```

##### 其他界面组件
```typescript
Tips.tsx                  # 提示信息中文化
InputPrompt.tsx           # 输入提示中文化
PrepareLabel.tsx          # 准备标签中文化
SuggestionsDisplay.tsx    # 建议显示中文化
LoopDetectionConfirmation.tsx  # 循环检测确认中文化
ShellConfirmationDialog.tsx    # Shell确认对话框中文化
```

#### 🔐 认证界面修改
```typescript
packages/cli/src/ui/auth/
├── AuthDialog.tsx        # 认证对话框中文化
│   修改内容: 认证选项、错误信息、帮助文本
├── useAuth.ts           # 认证逻辑中文化
    修改内容: 错误提示、状态信息
```

---

### 4. 🛠️ 辅助工具和钩子

#### 📂 自定义钩子系统
```typescript
packages/cli/src/ui/hooks/
├── hashCommandProcessor.ts     # #功能处理器
│   功能: 处理以#开头的特殊命令
│   
├── promptTemplateManager.ts    # 提示词模板管理
│   功能: 管理全局和项目提示词模板
│   
└── promptTemplateStorage.ts    # 提示词存储
    功能: 提示词的持久化存储
```

**升级注意**：⚠️ 这些文件是完全自定义的，升级时必须完整保留

#### 🔧 修改的工具模块
```typescript
packages/cli/src/ui/utils/
└── terminalSetup.ts
    修改内容: 终端设置的中文提示信息

packages/cli/src/utils/
└── dialogScopeUtils.ts
    修改内容: 对话框工具的中文化
```

---

### 5. 📝 命令功能详细说明

#### 🔧 原有命令的增强修改

##### `/about` 命令增强
```typescript
文件: packages/cli/src/ui/commands/aboutCommand.ts
修改内容:
  - 版本信息显示中文化
  - 添加"超级智体汉化版"标识
  - 中文的系统信息显示
```

##### `/tools` 命令增强
```typescript
文件: packages/cli/src/ui/commands/toolsCommand.ts
修改内容:
  - 工具列表中文化
  - 工具描述中文化
  - 使用说明中文化
```

##### `/vim` 命令增强
```typescript
文件: packages/cli/src/ui/commands/vimCommand.ts
修改内容:
  - Vim模式提示中文化
  - 帮助信息中文化
```

##### `/terminal-setup` 命令增强
```typescript
文件: packages/cli/src/ui/commands/terminalSetupCommand.ts
修改内容:
  - 终端设置说明中文化
  - 配置步骤中文化
  - 错误提示中文化
```

---

### 6. 🔐 安全和配置修改

#### OAuth 配置安全化
```typescript
文件: packages/core/src/code_assist/oauth2.ts
修改位置: 第31-44行
原始内容: 硬编码的OAuth客户端ID和密钥
修改内容: 改为环境变量，避免安全扫描问题

修改前:
const OAUTH_CLIENT_ID = '681255809395-oo8ft2oprdrnp9e3aqf6av3hmdib135j.apps.googleusercontent.com';
const OAUTH_CLIENT_SECRET = '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';

修改后:
const OAUTH_CLIENT_ID = process.env.OAUTH_CLIENT_ID || '681255809395-oo8ft2oprdrnp9e3aqf6av3hmdib135j.apps.googleusercontent.com';
const OAUTH_CLIENT_SECRET = process.env.OAUTH_CLIENT_SECRET || 'GOCSPX-[REDACTED-FOR-SECURITY-SCAN]';
```

---

### 7. 📦 项目配置修改

#### package.json 关键修改
```json
文件: package.json
修改内容:
{
  "name": "gemini-cli-chinese",
  "description": "Gemini CLI 中文汉化版...",
  "keywords": [...中文关键词...],
  "repository": {
    "url": "git+https://github.com/396001000/gemini-cli-chinese.git"
  },
  "scripts": {
    "start": "npm run start --workspace packages/cli",
    // 简化的脚本配置
  }
}
```

**升级策略**：
- 保留项目基本信息
- 更新版本号到官方最新
- 合并依赖更新
- 保持简化的脚本配置

---

## 🚨 升级时的关键保护点

### 1. ⚠️ 绝对不能丢失的文件
```
packages/cli/src/i18n/                    # 完整国际化系统
packages/cli/src/ui/commands/*Command.ts  # 所有新增命令
packages/cli/src/ui/hooks/                # 自定义钩子
tu/                                       # 功能截图
安装依赖.bat                               # 安装脚本
启动CLI.bat                               # 启动脚本
README-分发指南.md                         # 用户指南
```

### 2. ⚠️ 必须检查的关键修改点
```typescript
// 1. 命令注册
packages/cli/src/services/BuiltinCommandLoader.ts
// 确保所有自定义命令都被正确导入和注册

// 2. OAuth安全设置
packages/core/src/code_assist/oauth2.ts
// 确保环境变量化的修改被保留

// 3. 界面中文化
packages/cli/src/ui/components/*.tsx
// 确保中文化内容不被覆盖
```

### 3. ⚠️ 升级后必须测试的功能
```bash
# 基础功能
npm start                    # 确保能正常启动
/help                       # 确保帮助信息为中文

# 自定义命令
/baseurl                    # API端点设置
/setkey                     # API密钥设置  
/status                     # 状态查看
/globalprompt               # 全局提示词
/projectprompt              # 项目提示词

# 界面功能
/settings                   # 设置界面中文化
/auth                       # 认证界面中文化
```

---

## 📊 代码统计信息

### 📈 修改文件统计
```
新增文件: 20+ 个
修改文件: 30+ 个
中文翻译: 2000+ 条
新增命令: 10+ 个
中文化组件: 15+ 个
```

### 📁 文件分布
```
packages/cli/src/i18n/           # 3个文件 (新增)
packages/cli/src/ui/commands/    # 10个新增命令文件
packages/cli/src/ui/components/  # 15个修改的组件文件
packages/cli/src/ui/hooks/       # 3个新增钩子文件
packages/cli/src/ui/auth/        # 2个修改的认证文件
packages/core/src/code_assist/   # 1个安全修改文件
根目录/                          # 5个新增的用户文件
```

---

## 🔄 版本对应关系

### 📅 版本历史
```
中文汉化版 v1.0  ->  基于官方 v0.7.0-nightly.20250918.2722473a
中文汉化版 v1.1  ->  基于官方 v[下次升级版本]
```

### 🏷️ 分支策略
```
main                     # 主分支，稳定的中文汉化版
upgrade-*               # 升级分支，用于合并官方更新
backup-*                # 备份分支，升级前的完整备份
clean-main              # 当前开发分支
```

---

**📅 文档创建时间**: 2025年9月21日  
**📝 维护说明**: 每次升级后请更新本文档，记录新的修改点
**🔍 使用方法**: 升级前参考此文档，确保不遗漏任何自定义功能

> 💡 **重要提醒**: 本文档是升级的核心参考，请妥善保管并及时更新！
