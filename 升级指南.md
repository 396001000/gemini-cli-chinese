# Gemini CLI 中文汉化版 - 官方版本升级合并指南

> 📖 本文档详细说明如何将官方 Google Gemini CLI 的更新合并到我们的中文汉化增强版中

## 📋 目录

- [项目结构对比](#项目结构对比)
- [自定义功能清单](#自定义功能清单)
- [升级前准备工作](#升级前准备工作)
- [升级合并步骤](#升级合并步骤)
- [冲突解决策略](#冲突解决策略)
- [测试验证清单](#测试验证清单)
- [回滚方案](#回滚方案)

---

## 🏗️ 项目结构对比

### 📁 保留的官方目录结构
```
gemini-cli-chinese/
├── packages/
│   ├── cli/                    # CLI 核心代码（有修改）
│   ├── core/                   # 核心功能（有修改）
│   ├── a2a-server/            # A2A 服务器（保持官方）
│   ├── test-utils/            # 测试工具（保持官方）
│   └── vscode-ide-companion/  # VSCode 扩展（保持官方）
├── docs/                      # 文档目录（保持官方）
├── third_party/               # 第三方依赖（保持官方）
├── CONTRIBUTING.md            # 贡献指南（保持官方）
├── LICENSE                    # 许可证（保持官方）
├── SECURITY.md               # 安全政策（保持官方）
├── ROADMAP.md                # 路线图（保持官方）
└── tsconfig.json             # TS配置（保持官方）
```

### 🗑️ 已删除的官方目录
```
删除的目录/文件：
├── .github/                   # GitHub Actions 配置
├── integration-tests/         # 集成测试
├── scripts/                   # 构建脚本
├── launcher/                  # 启动器（已单独保存）
├── bundle/                    # 构建产物
├── esbuild.config.js         # 构建配置
├── eslint.config.js          # 代码检查配置
├── Dockerfile                # Docker 配置
└── Makefile                  # Make 配置
```

### ➕ 新增的中文汉化版文件
```
新增文件：
├── tu/                       # 功能截图目录
│   ├── 1.png                 # 启动界面截图
│   ├── 2.png                 # 命令列表截图
│   ├── 3.png                 # baseurl命令截图
│   ├── 4.png                 # 智能提示截图
│   └── 5.png                 # 系统配置截图
├── README-分发指南.md         # 用户安装使用指南
├── 安装依赖.bat              # Windows 一键安装脚本
├── 启动CLI.bat               # Windows 一键启动脚本
└── 升级指南.md               # 本文档
```

---

## 🎯 自定义功能清单

### 1. 🇨🇳 中文汉化系统

#### 📂 `packages/cli/src/i18n/` (完全新增)
```typescript
// 国际化系统文件
├── index.ts                   # 国际化主入口
├── types.ts                   # 类型定义
└── locales/
    └── zh-CN.ts              # 中文语言包
```

**功能说明**：
- 完整的国际化框架
- 支持动态语言切换
- 中文错误提示和帮助信息

#### 🔧 修改的界面文件
```typescript
// 主要修改的界面组件
packages/cli/src/ui/components/
├── Help.tsx                  # 帮助信息中文化
├── Tips.tsx                  # 提示信息中文化
├── Composer.tsx              # 输入组件中文化
├── DialogManager.tsx         # 对话框中文化
├── SettingsDialog.tsx        # 设置界面中文化
├── InputPrompt.tsx           # 输入提示中文化
├── PrepareLabel.tsx          # 准备标签中文化
└── SuggestionsDisplay.tsx    # 建议显示中文化
```

### 2. 🔧 增强命令系统

#### 📂 `packages/cli/src/ui/commands/` (新增命令)
```typescript
// 新增的中文汉化版专用命令
├── baseurlCommand.ts         # /baseurl - API端点设置
├── apiCommand.ts             # /api - 内部API端点设置  
├── setkeyCommand.ts          # /setkey - API密钥设置（增强）
├── statusCommand.ts          # /status - 配置状态查看
├── debugCommand.ts           # /debug - 调试模式配置
├── yoloCommand.ts            # /yolo - 自动执行模式
├── sandboxCommand.ts         # /sandbox - 沙盒设置
├── modelCommand.ts           # /model - 模型切换
├── globalPromptCommand.ts    # /globalprompt - 全局提示词
└── projectPromptCommand.ts   # /projectprompt - 项目提示词
```

**重要修改**：
```typescript
// packages/cli/src/services/BuiltinCommandLoader.ts
// 命令注册文件 - 需要保留所有新增命令的注册
```

### 3. 🎨 界面优化

#### 修改的认证界面
```typescript
packages/cli/src/ui/auth/
├── AuthDialog.tsx            # 认证对话框中文化
└── useAuth.ts               # 认证逻辑中文化
```

#### 修改的核心组件
```typescript
packages/cli/src/ui/commands/
├── aboutCommand.ts           # 关于信息中文化
├── terminalSetupCommand.ts   # 终端设置中文化
├── toolsCommand.ts           # 工具命令中文化
└── vimCommand.ts            # Vim模式中文化
```

### 4. 🛠️ 工具和辅助功能

#### 新增的辅助模块
```typescript
packages/cli/src/ui/hooks/
├── hashCommandProcessor.ts   # #功能处理器
├── promptTemplateManager.ts  # 提示词模板管理
└── promptTemplateStorage.ts  # 提示词存储
```

#### 修改的工具模块
```typescript
packages/cli/src/ui/utils/
└── terminalSetup.ts         # 终端设置工具中文化

packages/cli/src/utils/
└── dialogScopeUtils.ts      # 对话框工具中文化
```

### 5. 🔐 OAuth 安全处理

#### 修改的安全文件
```typescript
packages/core/src/code_assist/
└── oauth2.ts                # OAuth凭据环境变量化
```

**修改内容**：
```typescript
// 原始硬编码改为环境变量
const OAUTH_CLIENT_ID = process.env.OAUTH_CLIENT_ID || '原始值';
const OAUTH_CLIENT_SECRET = process.env.OAUTH_CLIENT_SECRET || 'GOCSPX-[REDACTED]';
```

---

## 🚀 升级前准备工作

### 1. 📋 创建升级分支
```bash
# 在项目根目录执行
cd F:\gemini-cli

# 创建升级分支
git checkout -b upgrade-to-v[新版本号]-$(date +%Y%m%d_%H%M%S)

# 例如：upgrade-to-v0.8.0-20250922_143000
```

### 2. 🔍 备份当前版本
```bash
# 创建完整备份分支
git checkout -b backup-before-upgrade-$(date +%Y%m%d)

# 推送备份到远程
git push origin backup-before-upgrade-$(date +%Y%m%d)

# 切换回升级分支
git checkout upgrade-to-v[新版本号]-$(date +%Y%m%d_%H%M%S)
```

### 3. 📊 记录当前功能状态
```bash
# 生成当前功能清单
echo "升级前功能状态 - $(date)" > upgrade-status.md
echo "=========================" >> upgrade-status.md
echo "" >> upgrade-status.md

# 记录自定义命令
echo "## 自定义命令列表" >> upgrade-status.md
ls packages/cli/src/ui/commands/*Command.ts | grep -E "(baseurl|api|setkey|status|debug|yolo|sandbox|model|globalprompt|projectprompt)" >> upgrade-status.md

# 记录中文化文件
echo "" >> upgrade-status.md
echo "## 中文化文件" >> upgrade-status.md
find packages/cli/src -name "*.ts" -o -name "*.tsx" | grep -E "(i18n|zh-CN)" >> upgrade-status.md

# 记录新增工具
echo "" >> upgrade-status.md
echo "## 新增工具模块" >> upgrade-status.md
ls packages/cli/src/ui/hooks/*.ts >> upgrade-status.md
```

---

## 🔄 升级合并步骤

### 第一步：添加官方远程仓库
```bash
# 添加官方仓库为上游
git remote add upstream https://github.com/google-gemini/gemini-cli.git

# 获取官方最新代码
git fetch upstream

# 查看官方版本标签
git tag -l --sort=-version:refname | head -10
```

### 第二步：创建合并策略
```bash
# 查看官方最新提交
git log upstream/main --oneline -10

# 查看我们的最后一次合并点
git log --grep="官方版本" --oneline -5

# 选择合并策略（推荐使用 merge 而不是 rebase）
git merge upstream/main --no-ff -m "🔄 合并官方 v[版本号] 更新

📝 合并说明:
- 基于官方 Gemini CLI v[版本号]
- 保留所有中文汉化功能
- 保留所有增强命令
- 需要解决合并冲突

🔧 主要官方更新:
[在这里列出官方的主要更新内容]
"
```

### 第三步：解决合并冲突

#### 🔍 预期的冲突文件
```bash
# 常见冲突文件清单
packages/cli/src/services/BuiltinCommandLoader.ts  # 命令注册冲突
packages/cli/src/ui/components/Help.tsx            # 帮助信息冲突
packages/cli/src/ui/components/Composer.tsx        # 界面组件冲突
packages/core/src/code_assist/oauth2.ts           # OAuth设置冲突
package.json                                       # 依赖和脚本冲突
```

#### 🛠️ 冲突解决原则
1. **保留我们的中文化内容**
2. **合并官方的新功能**
3. **保持我们的增强命令**
4. **更新依赖版本到官方最新**

---

## ⚔️ 冲突解决策略

### 1. 📦 package.json 冲突处理
```json
{
  // 保留我们的项目信息
  "name": "gemini-cli-chinese",
  "description": "Gemini CLI 中文汉化版...",
  "keywords": [...我们的关键词...],
  
  // 更新到官方最新版本
  "version": "官方最新版本号",
  
  // 合并依赖（优先使用官方最新版本）
  "dependencies": {
    // 官方依赖 + 我们新增的依赖
  },
  
  // 保留我们简化的脚本
  "scripts": {
    "start": "npm run start --workspace packages/cli",
    // 其他保留的脚本...
  }
}
```

### 2. 🔧 命令注册冲突 (BuiltinCommandLoader.ts)
```typescript
// 解决策略：保留所有官方命令 + 我们的新增命令
import { baseurlCommand } from '../ui/commands/baseurlCommand.js';
import { apiCommand } from '../ui/commands/apiCommand.js';
import { setkeyCommand } from '../ui/commands/setkeyCommand.js';
import { statusCommand } from '../ui/commands/statusCommand.js';
import { debugCommand } from '../ui/commands/debugCommand.js';
import { yoloCommand } from '../ui/commands/yoloCommand.js';
import { sandboxCommand } from '../ui/commands/sandboxCommand.js';
import { modelCommand } from '../ui/commands/modelCommand.js';
import { globalPromptCommand } from '../ui/commands/globalPromptCommand.js';
import { projectPromptCommand } from '../ui/commands/projectPromptCommand.js';

// 在 allDefinitions 数组中添加我们的命令
const allDefinitions = [
  // ...所有官方命令...
  baseurlCommand,
  apiCommand,
  setkeyCommand,
  statusCommand,
  debugCommand,
  yoloCommand,
  sandboxCommand,
  modelCommand,
  globalPromptCommand,
  projectPromptCommand,
];
```

### 3. 🎨 界面组件冲突处理
```typescript
// 对于中文化的组件，优先保留我们的中文版本
// 但要合并官方的新功能

// 示例：Help.tsx
// 1. 保留我们的中文化内容
// 2. 添加官方新增的帮助项
// 3. 保持中文化的格式
```

### 4. 🔐 OAuth 配置冲突
```typescript
// packages/core/src/code_assist/oauth2.ts
// 保留我们的环境变量化修改
const OAUTH_CLIENT_ID = 
  process.env.OAUTH_CLIENT_ID || '官方最新的客户端ID';
const OAUTH_CLIENT_SECRET = 
  process.env.OAUTH_CLIENT_SECRET || 'GOCSPX-[REDACTED-FOR-SECURITY-SCAN]';
```

---

## ✅ 测试验证清单

### 1. 🔧 基础功能测试
```bash
# 测试项目启动
npm start

# 测试基础命令
/help
/about
/quit
```

### 2. 🇨🇳 中文化功能测试
```bash
# 测试中文界面
/help           # 检查帮助信息是否为中文
/settings       # 检查设置界面中文化
/auth           # 检查认证界面中文化
```

### 3. 🆕 增强功能测试
```bash
# 测试新增命令
/baseurl        # API端点设置
/setkey         # API密钥设置
/status         # 状态查看
/debug          # 调试模式
/yolo           # 自动执行模式
/globalprompt   # 全局提示词
/projectprompt  # 项目提示词
```

### 4. 🔗 集成功能测试
```bash
# 测试API集成
/baseurl https://your-api-endpoint.com/v1
/setkey your-test-key
# 发送测试对话
```

### 5. 📁 文件功能测试
```bash
# 测试便民脚本
双击运行 安装依赖.bat
双击运行 启动CLI.bat
```

---

## 🔙 回滚方案

### 1. 🚨 紧急回滚
```bash
# 如果升级出现严重问题，立即回滚到备份分支
git checkout backup-before-upgrade-[日期]
git checkout -b emergency-rollback
git push origin emergency-rollback:main --force
```

### 2. 📋 部分回滚
```bash
# 如果只是某些文件有问题，可以单独回滚
git checkout backup-before-upgrade-[日期] -- packages/cli/src/ui/commands/[问题文件]
git commit -m "🔙 回滚问题文件: [文件名]"
```

### 3. 🔧 渐进式修复
```bash
# 创建修复分支
git checkout -b hotfix-upgrade-issues

# 逐个修复问题
git add [修复的文件]
git commit -m "🔧 修复升级问题: [具体问题描述]"

# 修复完成后合并
git checkout main
git merge hotfix-upgrade-issues
```

---

## 📝 升级后工作

### 1. 📊 更新项目信息
```bash
# 更新 README.md 中的版本信息
# 更新功能截图（如有界面变化）
# 更新 CHANGELOG.md（如果有的话）
```

### 2. 🧪 完整测试
```bash
# 运行完整的功能测试
# 测试所有自定义命令
# 验证中文化完整性
# 测试在不同环境下的兼容性
```

### 3. 📢 发布更新
```bash
# 创建发布标签
git tag -a v[新版本号]-chinese -m "🚀 Gemini CLI 中文汉化版 v[版本号]

基于官方 v[官方版本号] 更新
保持完整中文化功能
新增功能：[列出新功能]"

# 推送标签
git push origin v[新版本号]-chinese

# 在 GitHub 上创建 Release
```

---

## 🎯 重要注意事项

### ⚠️ 升级风险提醒
1. **备份重要性**：升级前必须创建完整备份
2. **测试重要性**：每次升级后必须完整测试所有功能
3. **用户通知**：重大升级需要通知用户可能的变化

### 📋 维护最佳实践
1. **定期升级**：建议每1-2个月检查官方更新
2. **渐进升级**：避免跨越多个大版本直接升级
3. **文档维护**：每次升级后更新本文档

### 🔍 监控官方动态
1. **关注官方仓库**：启用 GitHub 通知
2. **查看 Release Notes**：了解官方更新内容
3. **参与社区讨论**：关注官方 Issues 和 Discussions

---

## 📚 相关文档

- [README.md](./README.md) - 项目主文档
- [README-分发指南.md](./README-分发指南.md) - 用户使用指南
- [官方 Gemini CLI](https://github.com/google-gemini/gemini-cli) - 上游项目

---

**📅 文档创建时间**: 2025年9月21日  
**✍️ 维护者**: 396001000  
**🔄 最后更新**: 基于官方 v0.7.0-nightly.20250918.2722473a

> 💡 **提示**: 请在每次升级后更新本文档，记录新的经验和注意事项！
